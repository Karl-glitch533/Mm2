-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

-- Ensure that PlayerGui exists
if not LocalPlayer:FindFirstChild("PlayerGui") then
    warn("PlayerGui not found!")
    return
end

-- ScreenGui setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "VanxellHub"
ScreenGui.Parent = LocalPlayer.PlayerGui

-- Main Frame for Hub
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 300, 0, 400)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)  -- Centered position
MainFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
MainFrame.BorderColor3 = Color3.fromRGB(0, 255, 0)
MainFrame.Visible = true  -- Ensure it's visible on startup
MainFrame.Parent = ScreenGui

-- Title
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.Text = "Vanxell Hub"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Title.BorderColor3 = Color3.fromRGB(0, 255, 0)
Title.Parent = MainFrame

-- Function to create buttons
local function createButton(name, position, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -20, 0, 30)
    button.Position = position
    button.Text = name
    button.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    button.BorderColor3 = Color3.fromRGB(0, 255, 0)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Parent = MainFrame
    
    button.MouseButton1Click:Connect(function()
        pcall(callback)  -- Use pcall to catch errors in the callback
    end)
    return button
end

-- Grab Gun Button
createButton("Grab Gun", UDim2.new(0, 10, 0, 50), function()
    local sheriffAlive = false
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Backpack:FindFirstChild("Gun") then
            sheriffAlive = true
            break
        end
    end

    if not sheriffAlive then
        for _, item in pairs(Workspace:GetDescendants()) do
            if item:IsA("Tool") and item.Name == "Gun" then
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = item.Handle.CFrame
                    item.Parent = LocalPlayer.Backpack
                    print("Gun grabbed successfully.")
                    return
                else
                    print("Local player's character or HumanoidRootPart is not found.")
                    return
                end
            end
        end
        print("No gun found in the workspace.")
    else
        print("Sheriff is still alive. You cannot grab the gun.")
    end
end)

-- Silent Shoot Toggle
local silentShootEnabled = false
createButton("Toggle Silent Shoot", UDim2.new(0, 10, 0, 90), function()
    silentShootEnabled = not silentShootEnabled
    print(silentShootEnabled and "Silent Shoot Enabled" or "Silent Shoot Disabled")
end)

-- Auto Candy Button
local autoCandyEnabled = false
createButton("Toggle Auto Candy", UDim2.new(0, 10, 0, 130), function()
    autoCandyEnabled = not autoCandyEnabled
    print(autoCandyEnabled and "Auto Candy Enabled" or "Auto Candy Disabled")
    
    if autoCandyEnabled then
        while autoCandyEnabled do
            wait(0.5)  -- Prevents script from freezing
            local nearestCandy = nil
            local nearestDistance = math.huge
            for _, item in pairs(Workspace:GetDescendants()) do
                if item:IsA("Part") and item.Name == "Candy" then
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - item.Position).magnitude
                    if distance < nearestDistance then
                        nearestDistance = distance
                        nearestCandy = item
                    end
                end
            end
            
            if nearestCandy then
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(nearestCandy.Position)
                    wait(1) -- Wait to collect the candy
                    print("Collected candy.")
                else
                    print("Local player's character or HumanoidRootPart is not found.")
                end
            else
                print("No candy found nearby.")
            end
        end
    end
end)

-- Kill All Button
createButton("Kill All", UDim2.new(0, 10, 0, 170), function()
    if LocalPlayer.Backpack:FindFirstChild("Knife") or LocalPlayer.Character:FindFirstChild("Knife") then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                player.Character.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
                wait(0.1) -- Small delay
                local knife = LocalPlayer.Character:FindFirstChild("Knife")
                if knife then
                    knife:Activate()
                    print("Killed " .. player.Name)
                else
                    print("Knife not found in the local player's character.")
                end
            end
        end
    else
        print("You need to be a murderer with a knife to use Kill All!")
    end
end)

-- ESP Functionality
local function createESP(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local esp = Instance.new("BoxHandleAdornment")
        esp.Size = Vector3.new(4, 4, 4)
        esp.Color3 = Color3.new(1, 0, 0) -- Red color for ESP
        esp.AlwaysOnTop = true
        esp.ZIndex = 10
        esp.Parent = player.Character.HumanoidRootPart
        print("ESP created for " .. player.Name)
    else
        print("Failed to create ESP for " .. player.Name)
    end
end

-- Listen for players joining
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        wait(1) -- Ensure the character is fully loaded
        createESP(player)
    end)
end)

-- Create ESP for existing players
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        player.CharacterAdded:Wait()  -- Ensure the character is loaded
        createESP(player)
    end
end)

-- Refresh ESP on round end (Heartbeat)
RunService.Heartbeat:Connect(function()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createESP(player)
        end
    end
end)

print("Script loaded successfully!")
